@model ReviewCreateViewModel

@{
    var returnUrl = Context.Request.Query["returnUrl"].ToString();
}

<div class="review-container col-12 col-lg-6">
    <header class="mb-3">
    </header>
    <h2 style="text-align: center; margin-bottom:2rem">Editar Reseña</h2>

    <article class="review-card ">
        <form asp-controller="Review" asp-action="Edit" method="post">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="PeliculaId" />
            @if (!string.IsNullOrEmpty(returnUrl))
            {
                <input type="hidden" name="returnUrl" value="@returnUrl" />
            }

            <div class="review-main mb-3">
                <div class="review-content">
                    <h4 class="">Pelicula: @Model.PeliculaTitulo</h4>

                    <div class="mb-3">
                        <label asp-for="Rating" class="form-label">Tu calificación</label>

                        <div id="rating-control" class="d-flex align-items-center gap-2">
                            <div class="rating-stars" data-max="5">
                                @for (var i = 1; i <= 5; i++)
                                {
                                    var starId = $"star{i}";
                                    <input type="radio"
                                           asp-for="Rating"
                                           value="@i"
                                           id="@starId"
                                           class="visually-hidden" />
                                    <label for="@starId"
                                           class="star d-inline-flex align-items-center"
                                           data-value="@i"
                                           title="@($"{i} estrellas")"
                                           style="cursor:pointer">
                                        <span class="material-symbols-outlined">star</span>
                                    </label>
                                }
                            </div>

                            <div class="review-rating-compact" id="rating-indicator">
                                <span class="material-symbols-outlined star-filled me-1">star</span>
                                <span id="rating-number" class="review-rating-number">@Model.Rating</span>
                            </div>
                        </div>

                        <span asp-validation-for="Rating" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Comentario" class="form-label">Comentario</label>
                        <textarea asp-for="Comentario" class="form-control" rows="4" placeholder="Comparte tu opinión sobre esta película..."></textarea>
                        <span asp-validation-for="Comentario" class="text-danger"></span>
                    </div>
                </div>
            </div>

            <div class="review-footer">
                <button type="submit" class="btn app-btn app-btn-ghost">Guardar Cambios</button>
                @if (!string.IsNullOrEmpty(returnUrl))
                {
                    <a href="@returnUrl" class="btn app-btn btn-outline-danger">Cancelar</a>
                }
                else
                {
                    <a asp-action="Index" class="btn app-btn btn-outline-danger">Cancelar</a>
                }
            </div>
        </form>
    </article>
</div>

@section Scripts {
    <script>
        (function () {
            var initial = @Model.Rating;
            var selectedValue = initial || 0;
            var stars = document.querySelectorAll('.rating-stars .star');
            var inputs = document.querySelectorAll('.rating-stars input[type="radio"]');
            var numberEl = document.getElementById('rating-number');
            var container = document.querySelector('.rating-stars');

            function renderVisual(value) {
                stars.forEach(function (label) {
                    var v = parseInt(label.dataset.value, 10);
                    var icon = label.querySelector('.material-symbols-outlined');
                    var filled = v <= value;
                    icon.textContent = filled ? 'star' : 'star_outline';
                    icon.classList.toggle('active', filled);
                });
                numberEl.textContent = value;
            }

            function renderSelected(value) {
                selectedValue = value;
                renderVisual(value);
                inputs.forEach(function (input) {
                    input.checked = parseInt(input.value, 10) === value;
                });
            }

            // init
            renderSelected(selectedValue);

            // Hover should only change visuals, not selection
            stars.forEach(function (label) {
                label.addEventListener('mouseenter', function () {
                    renderVisual(parseInt(label.dataset.value, 10));
                });
                label.addEventListener('click', function () {
                    renderSelected(parseInt(label.dataset.value, 10));
                });
            });

            // Restore visuals to selected on mouseleave
            container.addEventListener('mouseleave', function () {
                renderVisual(selectedValue);
            });
        })();
    </script>
}