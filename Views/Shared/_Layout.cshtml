@using Microsoft.AspNetCore.Identity
@inject SignInManager<Usuario> SignInManager
@inject UserManager<Usuario> UserManager

@{
    var controller = ViewContext.RouteData.Values["controller"]?.ToString();
    var action = ViewContext.RouteData.Values["action"]?.ToString();

    string IsActive(string c, string? a = null)
        => controller == c && (a is null || action == a) ? "active" : "";
}

<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - MovieApp</title>

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" />

    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />

    <!-- Biblioteca personalizada -->
    @* vistas *@
    <link rel="stylesheet" href="~/css/layout.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
    @* controles *@
    <link rel="stylesheet" href="~/css/buttons.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/forms.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/tables.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/alerts.css" asp-append-version="true" />
    @* --- fin de biblioteca ---*@

    <link rel="stylesheet" href="~/app_movie_mvc.styles.css" asp-append-version="true" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    @await RenderSectionAsync("Styles", required: false)
</head>

<body class="app-body">
    <header class="app-navbar-wrapper sticky-top">
        <nav class="navbar navbar-expand-lg navbar-dark app-navbar" role="navigation" aria-label="Main navigation">
            <div class="container">

                <a class="navbar-brand d-flex align-items-center gap-2 app-brand" asp-area="" asp-controller="Home" asp-action="Index">

                    <svg class="app-brand-icon" height="32" viewBox="0 0 115 32" fill="none"
                        aria-hidden="true">

                        <text x="0" y="23"
                              fill="currentColor"
                              font-family="ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial"
                              font-size="20"
                              font-weight="700"
                              letter-spacing="0.05"
                              style="font-style: italic;">
                            <tspan font-style="normal" font-weight="600">.</tspan>Movie<tspan font-style="normal" font-weight="600">App</tspan>
                        </text>
                    </svg>
                </a>

                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
                        aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="mainNav">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0 gap-lg-1">
                        <li class="nav-item">
                            <a class="nav-link app-nav-link @IsActive("Home", "Index")" asp-area="" asp-controller="Home" asp-action="Index">Home</a>
                        </li>

                        @if (SignInManager.IsSignedIn(User))
                        {
                            var currentUser = await UserManager.GetUserAsync(User);
                            if (currentUser != null && await UserManager.IsInRoleAsync(currentUser, "Admin"))
                            {
                                <li class="nav-item">
                                    <a class="nav-link app-nav-link @IsActive("Genero")" asp-area="" asp-controller="Genero" asp-action="Index">Géneros</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link app-nav-link @IsActive("Plataforma")" asp-area="" asp-controller="Plataforma" asp-action="Index">Plataformas</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link app-nav-link @IsActive("Pelicula")" asp-area="" asp-controller="Pelicula" asp-action="Index">Películas</a>
                                </li>
                            }
                            else
                            {
                                <li class="nav-item">
                                    <a class="nav-link app-nav-link @IsActive("Review")" asp-area="" asp-controller="Review" asp-action="Index">Mis Reseñas</a>
                                </li>
                            }
                        }
                    </ul>

                    <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-2 app-auth">
                        @if (SignInManager.IsSignedIn(User))
                        {
                            <span class="app-user-name d-none d-lg-inline">@User.Identity?.Name</span>

                            <a class="btn btn-sm app-btn app-btn-primary"
                               asp-area="" asp-controller="Usuario" asp-action="MiPerfil">
                                Perfil
                            </a>

                            <form asp-area="" asp-controller="Usuario" asp-action="Logout" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm app-btn app-btn-ghost">
                                    Cerrar sesión
                                </button>
                            </form>
                        }
                        else
                        {
                            <a class="btn btn-sm app-btn app-btn-ghost"
                               asp-area="" asp-controller="Usuario" asp-action="Login">
                                Iniciar sesión
                            </a>
                            <a class="btn btn-sm app-btn app-btn-primary"
                               asp-area="" asp-controller="Usuario" asp-action="Registro">
                                Registrarse
                            </a>
                        }
                    </div>
                </div>

            </div>
        </nav>
    </header>

    <main role="main" class="container app-main flex-grow-1">
        @RenderBody()
    </main>

    <footer class="app-footer mt-auto">
        <div class="container py-3 d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
            <div class="app-footer-text small">&copy; 2025 MovieApp · ASP.NET Core MVC</div>
            <a class="app-footer-link small" asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>

    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)

</body>
</html>